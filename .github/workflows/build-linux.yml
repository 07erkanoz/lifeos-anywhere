name: Build Linux .deb Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-linux-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libglib2.0-dev \
            libdbus-1-dev libnotify-dev \
            libayatana-appindicator3-dev \
            xvfb

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux release
        run: flutter build linux --release

      - name: Create .deb package
        run: |
          set -e

          PKG_NAME="lifeos-anywhere"
          PKG_VERSION="1.0.0"
          PKG_ARCH="amd64"
          PKG_DIR="${PKG_NAME}_${PKG_VERSION}_${PKG_ARCH}"
          BUNDLE_DIR="build/linux/x64/release/bundle"

          # Create package directory structure
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/opt/${PKG_NAME}"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/applications"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/256x256/apps"

          # Copy the entire bundle
          cp -r "${BUNDLE_DIR}/." "${PKG_DIR}/opt/${PKG_NAME}/"

          # Create symlink for PATH access
          ln -sf "/opt/${PKG_NAME}/lifeos_anywhere" "${PKG_DIR}/usr/bin/lifeos_anywhere"

          # Create .desktop file
          cat > "${PKG_DIR}/usr/share/applications/com.lifeos.anyware.desktop" << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=LifeOS AnyWhere
          Comment=Cross-platform local network file sharing
          Exec=/opt/lifeos-anywhere/lifeos_anywhere
          Icon=com.lifeos.anyware
          Terminal=false
          Categories=Network;FileTransfer;Utility;
          Keywords=share;file;transfer;local;network;
          StartupWMClass=lifeos_anywhere
          DESKTOP

          # Remove leading spaces from .desktop file (heredoc indentation)
          sed -i 's/^          //' "${PKG_DIR}/usr/share/applications/com.lifeos.anyware.desktop"

          # Create DEBIAN/control
          cat > "${PKG_DIR}/DEBIAN/control" << CONTROL
          Package: ${PKG_NAME}
          Version: ${PKG_VERSION}
          Architecture: ${PKG_ARCH}
          Maintainer: 07erkanoz <erkanoz07@gmail.com>
          Description: LifeOS AnyWhere - Cross-platform local network file sharing
           Share files instantly between devices on the same local network.
           Supports Windows, Linux, macOS, Android, and Android TV.
          Depends: libgtk-3-0, libnotify4, libayatana-appindicator3-1
          Section: net
          Priority: optional
          Homepage: https://github.com/07erkanoz/lifeos-anywhere
          CONTROL

          # Remove leading spaces from control file
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/control"

          # Set correct permissions
          chmod 755 "${PKG_DIR}/DEBIAN"
          chmod 755 "${PKG_DIR}/opt/${PKG_NAME}/lifeos_anywhere"
          find "${PKG_DIR}/opt/${PKG_NAME}/lib" -name "*.so*" -exec chmod 644 {} \;

          # Build the .deb package
          dpkg-deb --build --root-owner-group "${PKG_DIR}"

          echo "âœ… Package created: ${PKG_DIR}.deb"
          ls -lh "${PKG_DIR}.deb"

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: lifeos-anywhere-linux-deb
          path: lifeos-anywhere_1.0.0_amd64.deb
          retention-days: 30
